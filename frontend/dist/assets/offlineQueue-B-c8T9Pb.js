const w="forge-offline-queue";const i="requests";function c(){return typeof window<"u"}function u(){return new Promise((e,o)=>{const n=indexedDB.open(w,1);n.onupgradeneeded=()=>{const r=n.result;r.objectStoreNames.contains(i)||r.createObjectStore(i,{keyPath:"id",autoIncrement:!0}).createIndex("createdAt","createdAt",{unique:!1})},n.onsuccess=()=>e(n.result),n.onerror=()=>o(n.error||new Error("Failed to open offline queue DB"))})}function f(e){return new Promise((o,n)=>{e.oncomplete=()=>o(),e.onerror=()=>n(e.error||new Error("IndexedDB transaction failed")),e.onabort=()=>n(e.error||new Error("IndexedDB transaction aborted"))})}async function l(){if(!c())return;const e=await y();window.dispatchEvent(new CustomEvent("offline-queue-updated",{detail:{count:e}}))}async function b(e,o,n){if(typeof indexedDB>"u")return;const r=await u(),s=r.transaction(i,"readwrite");s.objectStore(i).add({url:e,method:String(o).toUpperCase(),body:n??null,createdAt:Date.now()}),await f(s),r.close(),await l()}function p(){const e={"Content-Type":"application/json"};if(c()){const o=localStorage.getItem("forge_token");o&&(e.Authorization=`Bearer ${o}`)}return e}async function h(){if(typeof indexedDB>"u"||c()&&!navigator.onLine)return 0;const e=await u(),o=e.transaction(i,"readwrite"),n=o.objectStore(i),r=await new Promise((t,a)=>{const d=n.getAll();d.onsuccess=()=>t(d.result||[]),d.onerror=()=>a(d.error||new Error("Failed to read offline queue"))});r.sort((t,a)=>(t.createdAt||0)-(a.createdAt||0));let s=0;for(const t of r)try{const a=t.headers&&typeof t.headers=="object"?t.headers:{};(await fetch(t.url,{method:t.method||"POST",headers:{...a,...p()},body:t.rawBody!=null?t.rawBody:t.body!=null?JSON.stringify(t.body):void 0})).ok&&(n.delete(t.id),s+=1)}catch{break}return await f(o),e.close(),await l(),c()&&s>0&&window.dispatchEvent(new CustomEvent("offline-queue-flushed",{detail:{flushedCount:s}})),s}async function y(){if(typeof indexedDB>"u")return 0;const e=await u(),o=e.transaction(i,"readonly"),n=o.objectStore(i),r=await new Promise((s,t)=>{const a=n.count();a.onsuccess=()=>s(a.result||0),a.onerror=()=>t(a.error||new Error("Failed to count offline queue"))});return await f(o),e.close(),r}export{h as f,y as g,b as q};
